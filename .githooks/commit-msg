#!/bin/bash
# Auto-bump semver in engine.js based on conventional commit message.
#
# Strategy: commit-msg hook determines the new version and writes it to
# a temp file. post-commit hook reads it, stages, and amends.
#
# feat!: or BREAKING CHANGE → major bump (v1.0.0 → v2.0.0)
# feat:                      → minor bump (v1.0.0 → v1.1.0)
# everything else            → patch bump (v1.0.0 → v1.0.1)
#
# Only bumps when game files are in the commit (engine.js, index.html, server.js)

ENGINE="engine.js"
MSG_FILE="$1"
MSG=$(head -1 "$MSG_FILE")
BUMP_FILE=".git/PENDING_VERSION_BUMP"

# Clean up any stale bump file
rm -f "$BUMP_FILE"

# Skip merges, amends from post-commit, and version bump commits
if echo "$MSG" | grep -qE '^Merge |^chore\(version\):'; then
    exit 0
fi

# Only bump if game files are staged
if ! git diff --cached --name-only | grep -qE '^(engine\.js|index\.html|server\.js|continuous-sim\.js|difficulty-regression\.js)$'; then
    exit 0
fi

# Extract current version from the STAGED version of engine.js (not working tree)
CURRENT=$(git show :engine.js 2>/dev/null | grep -oP "BUILD_VERSION = 'v\K[0-9]+\.[0-9]+\.[0-9]+")
if [ -z "$CURRENT" ]; then
    # Fallback to working tree
    CURRENT=$(grep -oP "BUILD_VERSION = 'v\K[0-9]+\.[0-9]+\.[0-9]+" "$ENGINE")
fi
if [ -z "$CURRENT" ]; then
    echo "Warning: Could not find BUILD_VERSION in $ENGINE"
    exit 0
fi

MAJOR=$(echo "$CURRENT" | cut -d. -f1)
MINOR=$(echo "$CURRENT" | cut -d. -f2)
PATCH=$(echo "$CURRENT" | cut -d. -f3)

# Determine bump type from conventional commit message
if echo "$MSG" | grep -qE '^[a-z]+(\(.+\))?!:|BREAKING CHANGE'; then
    MAJOR=$((MAJOR + 1))
    MINOR=0
    PATCH=0
    BUMP="major"
elif echo "$MSG" | grep -qE '^feat(\(.+\))?:'; then
    MINOR=$((MINOR + 1))
    PATCH=0
    BUMP="minor"
else
    PATCH=$((PATCH + 1))
    BUMP="patch"
fi

NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"

# Write bump info for post-commit hook
echo "${NEW_VERSION}" > "$BUMP_FILE"
echo "[$BUMP] v${CURRENT} → ${NEW_VERSION}"
