<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Game Lab</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      background: #0a0a0f;
      color: #fff;
      font-family: 'Courier New', monospace;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    body.in-menu {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    body.in-game {
      overflow: hidden;
      touch-action: none;
    }
    #app {
      width: 100%;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 24px 20px 40px;
      max-width: 420px;
      width: 100%;
    }
    .menu-title {
      font-size: 28px;
      font-weight: bold;
      letter-spacing: 6px;
      color: #4af;
      margin-top: 20px;
      margin-bottom: 4px;
    }
    .menu-sub {
      font-size: 12px;
      color: rgba(255,255,255,0.35);
      margin-bottom: 16px;
    }
    .menu-links {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
    }
    .menu-link {
      background: none;
      border: none;
      color: rgba(255,255,255,0.35);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .menu-link:hover { color: rgba(255,255,255,0.7); }
    .game-btn {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      color: #fff;
      font-family: inherit;
      font-size: 15px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.12s;
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }
    .game-btn:hover, .game-btn:active {
      background: rgba(68,170,255,0.1);
      border-color: rgba(68,170,255,0.3);
    }
    .game-btn .icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .game-btn .info { flex: 1; }
    .game-btn .name { font-weight: bold; font-size: 14px; }
    .game-btn .desc { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; }
    .game-btn .tags { font-size: 10px; color: rgba(255,255,255,0.25); margin-top: 3px; }
    #game-container {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      display: none;
      position: fixed;
      top: 0; left: 0;
    }
    #game-canvas {
      display: block;
      touch-action: none;
    }
    .overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.75);
      gap: 14px;
      z-index: 10;
    }
    .overlay-title { font-size: 28px; font-weight: bold; letter-spacing: 3px; }
    .overlay-score { font-size: 18px; color: rgba(255,255,255,0.8); }
    .overlay-reason { font-size: 13px; color: rgba(255,255,255,0.4); }
    .overlay-id { font-size: 10px; color: rgba(255,255,255,0.2); margin-top: 4px; }
    .btn-row { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; justify-content: center; }
    .action-btn {
      padding: 10px 28px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: #fff;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.12s;
    }
    .action-btn:hover {
      background: rgba(68,170,255,0.15);
      border-color: rgba(68,170,255,0.3);
    }
    .action-btn.primary {
      background: rgba(68,170,255,0.2);
      border-color: rgba(68,170,255,0.4);
    }
    .back-btn {
      position: absolute;
      top: 8px; left: 8px;
      z-index: 20;
      padding: 6px 12px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6);
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    .back-btn:hover { color: #fff; border-color: rgba(255,255,255,0.3); }
    .calibrate-btn {
      position: absolute;
      bottom: 12px; right: 12px;
      z-index: 20;
      padding: 8px 14px;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(100,200,255,0.25);
      color: rgba(100,200,255,0.7);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      border-radius: 4px;
      letter-spacing: 1px;
      display: none;
    }
    .calibrate-btn:active { background: rgba(100,200,255,0.15); }
    .pause-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.8);
      gap: 20px;
      z-index: 30;
    }
    .pause-overlay .pause-msg {
      font-size: 15px;
      color: rgba(255,255,255,0.7);
      text-align: center;
      line-height: 1.6;
    }
    .mode-badge {
      position: absolute;
      top: 8px; right: 8px;
      z-index: 20;
      padding: 4px 10px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.5);
      font-family: inherit;
      font-size: 11px;
      border-radius: 4px;
      letter-spacing: 1px;
    }
    /* Pre-game screen */
    .pregame {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 40px 20px;
      max-width: 380px;
      width: 100%;
    }
    .pregame-icon {
      width: 64px; height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    .pregame-name {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 3px;
    }
    .pregame-desc {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }
    .pregame-tags {
      font-size: 11px;
      color: rgba(255,255,255,0.3);
    }
    .pregame-section {
      width: 100%;
      margin-top: 8px;
    }
    .pregame-label {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    .slider-row input[type=range] {
      flex: 1;
      accent-color: #4af;
    }
    .slider-val {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      min-width: 36px;
      text-align: right;
    }
    /* Sessions list */
    .session-item {
      width: 100%;
      padding: 10px 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.12s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .session-item:hover {
      background: rgba(68,170,255,0.08);
      border-color: rgba(68,170,255,0.2);
    }
    .session-game { font-size: 13px; font-weight: bold; }
    .session-score { font-size: 13px; color: rgba(255,255,255,0.6); }
    .session-time { font-size: 10px; color: rgba(255,255,255,0.25); }
    .session-bot { font-size: 10px; color: #4af; }
    /* Settings */
    .settings-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    .settings-label { font-size: 13px; color: rgba(255,255,255,0.7); }
  </style>
</head>
<body class="in-menu">
  <div id="app">
    <div id="menu" class="menu"></div>
    <div id="game-container">
      <button class="back-btn" id="back-btn">&larr; MENU</button>
      <div class="mode-badge" id="mode-badge" style="display:none"></div>
      <button class="calibrate-btn" id="calibrate-btn">CALIBRATE</button>
      <canvas id="game-canvas"></canvas>
    </div>
  </div>

  <script type="module">
    import { createBrowserRunner, createReplayRunner } from '/platform/core.js';
    import { createInputCapture } from '/platform/input.js';
    import { createRenderer } from '/platform/renderer.js';
    import { createAudioEngine } from '/platform/audio.js';

    // -----------------------------------------------------------------------
    // Game Registry — games register themselves, no hard-coded list
    // -----------------------------------------------------------------------
    const GAMES = [];

    function registerGame(entry) {
      GAMES.push(entry);
    }

    // Register all games
    const gameModules = await Promise.all([
      import('/games/dodge/game.js').then(m => ({ id: 'dodge', name: 'Dodge', desc: 'Steer to avoid obstacles', tags: 'thumb · survive', color: '#4af', icon: '\u25C7', createGame: m.createGame })),
      import('/games/rhythm/game.js').then(m => ({ id: 'rhythm', name: 'Rhythm', desc: 'Tap beats to the music', tags: 'taps · timing', color: '#f4a', icon: '\u266A', createGame: m.createGame })),
      import('/games/territory/game.js').then(m => ({ id: 'territory', name: 'Territory', desc: 'Capture the board (2P)', tags: 'taps · strategy · pvp', color: '#4fa', icon: '\u25C8', createGame: m.createGame })),
      import('/games/stack/game.js').then(m => ({ id: 'stack', name: 'Stack', desc: 'Time your drops perfectly', tags: 'taps · precision', color: '#fa4', icon: '\u25A2', createGame: m.createGame })),
      import('/games/snake/game.js').then(m => ({ id: 'snake', name: 'Snake', desc: 'Eat, grow, survive', tags: 'thumb · classic', color: '#4f4', icon: '~', createGame: m.createGame })),
      import('/games/breakout/game.js').then(m => ({ id: 'breakout', name: 'Breakout', desc: 'Smash all the bricks', tags: 'thumb · physics', color: '#f84', icon: '\u25A3', createGame: m.createGame })),
      import('/games/aim/game.js').then(m => ({ id: 'aim', name: 'Aim Trainer', desc: 'Test your reflexes', tags: 'taps · speed', color: '#f44', icon: '\u25CE', createGame: m.createGame })),
      import('/games/balance/game.js').then(m => ({ id: 'balance', name: 'Balance', desc: 'Tilt to keep the ball', tags: 'thumb/gyro · physics', color: '#6cf', icon: '\u25CB', createGame: m.createGame })),
      import('/games/pong/game.js').then(m => ({ id: 'pong', name: 'Pong', desc: 'Classic paddle battle (2P)', tags: 'thumb · pvp', color: '#ff4', icon: '|', createGame: m.createGame })),
      import('/games/runner/game.js').then(m => ({ id: 'runner', name: 'Runner', desc: 'Dodge and jump endlessly', tags: 'thumb+taps · lanes', color: '#a4f', icon: '\u25B8', createGame: m.createGame })),
      import('/games/orbit/game.js').then(m => ({ id: 'orbit', name: 'Orbit', desc: 'Slingshot through space', tags: 'taps · gravity', color: '#4ff', icon: '\u25CC', createGame: m.createGame })),
      import('/games/meteor/game.js').then(m => ({ id: 'meteor', name: 'Meteor', desc: 'Asteroids-style shooter', tags: 'thumb · shoot', color: '#fa0', icon: '\u2726', createGame: m.createGame })),
    ]);
    gameModules.forEach(registerGame);

    // -----------------------------------------------------------------------
    // DOM elements
    // -----------------------------------------------------------------------
    const menuEl = document.getElementById('menu');
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('game-canvas');
    const backBtn = document.getElementById('back-btn');
    const modeBadge = document.getElementById('mode-badge');
    const calibrateBtn = document.getElementById('calibrate-btn');

    let currentRunner = null;
    let currentInput = null;
    let audioEngine = null;
    let buildVersion = '';
    let lastSession = null; // last completed session data for replay
    let lastSessionId = null;
    let masterVolume = parseFloat(localStorage.getItem('gl_volume') || '0.5');

    fetch('/api/version').then(r => r.json()).then(d => {
      buildVersion = d.version;
      const sub = document.querySelector('.menu-sub');
      if (sub) sub.textContent = `${GAMES.length} experiments · v${buildVersion}`;
    }).catch(() => {});

    // -----------------------------------------------------------------------
    // Audio init
    // -----------------------------------------------------------------------
    function ensureAudio() {
      if (!audioEngine) {
        audioEngine = createAudioEngine();
        audioEngine.setVolume(masterVolume);
      }
      audioEngine.resume();
      return audioEngine;
    }

    // -----------------------------------------------------------------------
    // SCREEN: Main Menu
    // -----------------------------------------------------------------------
    function showMenu() {
      stopGame();
      document.body.className = 'in-menu';
      menuEl.style.display = 'flex';
      gameContainer.style.display = 'none';
      document.title = 'Game Lab';
      history.pushState(null, '', '/');

      menuEl.innerHTML = '';

      const title = document.createElement('div');
      title.className = 'menu-title';
      title.textContent = 'GAME LAB';
      menuEl.appendChild(title);

      const sub = document.createElement('div');
      sub.className = 'menu-sub';
      sub.textContent = `${GAMES.length} experiments${buildVersion ? ' \u00B7 v' + buildVersion : ''}`;
      menuEl.appendChild(sub);

      // Menu links
      const links = document.createElement('div');
      links.className = 'menu-links';
      const sessionsLink = document.createElement('button');
      sessionsLink.className = 'menu-link';
      sessionsLink.textContent = 'REPLAYS';
      sessionsLink.onclick = showSessionsList;
      links.appendChild(sessionsLink);
      const settingsLink = document.createElement('button');
      settingsLink.className = 'menu-link';
      settingsLink.textContent = 'SETTINGS';
      settingsLink.onclick = showSettings;
      links.appendChild(settingsLink);
      menuEl.appendChild(links);

      for (const game of GAMES) {
        const btn = document.createElement('button');
        btn.className = 'game-btn';
        btn.innerHTML = `
          <div class="icon" style="background:${game.color}22;color:${game.color}">${game.icon}</div>
          <div class="info">
            <div class="name">${game.name}</div>
            <div class="desc">${game.desc}</div>
            <div class="tags">${game.tags}</div>
          </div>
        `;
        btn.onclick = () => showPreGame(game);
        menuEl.appendChild(btn);
      }
    }

    // -----------------------------------------------------------------------
    // SCREEN: Pre-Game
    // -----------------------------------------------------------------------
    function showPreGame(entry) {
      stopGame();
      document.body.className = 'in-menu';
      menuEl.style.display = 'flex';
      gameContainer.style.display = 'none';
      document.title = entry.name + ' \u2014 Game Lab';
      history.pushState({ game: entry.id, screen: 'pregame' }, '', '/' + entry.id);

      menuEl.innerHTML = '';

      const pg = document.createElement('div');
      pg.className = 'pregame';

      // Back to menu
      const backLink = document.createElement('button');
      backLink.className = 'menu-link';
      backLink.textContent = '\u2190 Back to menu';
      backLink.style.alignSelf = 'flex-start';
      backLink.onclick = showMenu;
      pg.appendChild(backLink);

      // Game icon
      const icon = document.createElement('div');
      icon.className = 'pregame-icon';
      icon.style.cssText = `background:${entry.color}22;color:${entry.color}`;
      icon.textContent = entry.icon;
      pg.appendChild(icon);

      // Game info
      const name = document.createElement('div');
      name.className = 'pregame-name';
      name.textContent = entry.name;
      pg.appendChild(name);

      const desc = document.createElement('div');
      desc.className = 'pregame-desc';
      desc.textContent = entry.desc;
      pg.appendChild(desc);

      const tags = document.createElement('div');
      tags.className = 'pregame-tags';
      tags.textContent = entry.tags;
      pg.appendChild(tags);

      // Check if game has a bot
      const tempG = entry.createGame({});
      const hasBot = typeof tempG.bot === 'function';

      // Difficulty slider (for bot mode)
      let difficultyValue = 0.5;
      if (hasBot) {
        const section = document.createElement('div');
        section.className = 'pregame-section';
        const label = document.createElement('div');
        label.className = 'pregame-label';
        label.textContent = 'Bot Difficulty';
        section.appendChild(label);

        const row = document.createElement('div');
        row.className = 'slider-row';
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = '0';
        slider.max = '100';
        slider.value = '50';
        const valLabel = document.createElement('span');
        valLabel.className = 'slider-val';
        valLabel.textContent = '50%';
        slider.oninput = () => {
          difficultyValue = parseInt(slider.value) / 100;
          valLabel.textContent = slider.value + '%';
        };
        row.appendChild(slider);
        row.appendChild(valLabel);
        section.appendChild(row);
        pg.appendChild(section);
      }

      // Buttons
      const btnRow = document.createElement('div');
      btnRow.className = 'btn-row';
      btnRow.style.marginTop = '16px';

      const playBtn = document.createElement('button');
      playBtn.className = 'action-btn primary';
      playBtn.textContent = 'PLAY';
      playBtn.onclick = () => launchGame(entry, 'play');
      btnRow.appendChild(playBtn);

      if (hasBot) {
        const watchBtn = document.createElement('button');
        watchBtn.className = 'action-btn';
        watchBtn.textContent = 'WATCH BOT';
        watchBtn.onclick = () => launchGame(entry, 'bot', difficultyValue);
        btnRow.appendChild(watchBtn);
      }

      pg.appendChild(btnRow);
      menuEl.appendChild(pg);
    }

    // -----------------------------------------------------------------------
    // SCREEN: Playing / Bot / Replay
    // -----------------------------------------------------------------------
    function launchGame(entry, mode = 'play', botDifficulty = 0.5) {
      document.body.className = 'in-game';
      menuEl.style.display = 'none';
      gameContainer.style.display = 'block';
      document.title = entry.name + ' \u2014 Game Lab';
      if (mode === 'play' || mode === 'bot') {
        history.pushState({ game: entry.id, mode }, '', '/' + entry.id);
      }

      const oldOverlay = gameContainer.querySelector('.overlay');
      if (oldOverlay) oldOverlay.remove();

      resizeCanvas();

      const gameModule = { createGame: entry.createGame };
      ensureAudio();

      // Mode badge
      if (mode === 'bot') {
        modeBadge.textContent = 'SPECTATING';
        modeBadge.style.display = 'block';
      } else if (mode === 'replay') {
        modeBadge.textContent = 'REPLAY';
        modeBadge.style.display = 'block';
      } else {
        modeBadge.style.display = 'none';
      }

      currentRunner = createBrowserRunner(gameModule, canvas, { mode, botDifficulty });
      currentRunner.setRenderer(createRenderer());

      // Show calibrate button for gyro games
      const tempG = gameModule.createGame({});
      const isGyroGame = (tempG.meta.inputChannels || []).includes('gyro');
      calibrateBtn.style.display = (isGyroGame && mode === 'play') ? 'block' : 'none';

      if (mode === 'play') {
        currentInput = createInputCapture(canvas);
        currentInput.attach();
        // Calibrate gyro baseline to current phone orientation
        currentInput.calibrateGyro();
        currentRunner.setInput(currentInput);
      }

      currentRunner.setAudio(audioEngine);

      currentRunner.setOnEnd((score, reason) => {
        calibrateBtn.style.display = 'none';
        lastSession = currentRunner.getSession();
        saveSession(lastSession).then(id => { lastSessionId = id; });
        showEndOverlay(entry, score, reason, mode);
      });

      currentRunner.start();
    }

    function launchReplay(entry, session) {
      document.body.className = 'in-game';
      menuEl.style.display = 'none';
      gameContainer.style.display = 'block';
      document.title = entry.name + ' Replay \u2014 Game Lab';

      const oldOverlay = gameContainer.querySelector('.overlay');
      if (oldOverlay) oldOverlay.remove();

      resizeCanvas();

      const gameModule = { createGame: entry.createGame };
      ensureAudio();

      modeBadge.textContent = 'REPLAY';
      modeBadge.style.display = 'block';

      currentRunner = createReplayRunner(gameModule, canvas, session);
      currentRunner.setRenderer(createRenderer());
      currentRunner.setAudio(audioEngine);

      currentRunner.setOnEnd((score, reason) => {
        showEndOverlay(entry, score, reason, 'replay');
      });

      currentRunner.start();
    }

    // -----------------------------------------------------------------------
    // SCREEN: Game Over / Results
    // -----------------------------------------------------------------------
    function showEndOverlay(entry, score, reason, mode) {
      const overlay = document.createElement('div');
      overlay.className = 'overlay';

      const title = mode === 'replay' ? 'REPLAY END' : (mode === 'bot' ? 'BOT FINISHED' : 'GAME OVER');

      let scoreText = `${score.label || 'Score'}: ${score.primary}${score.unit || ''}`;
      if (score.players) {
        scoreText = `${score.players[0]} - ${score.players[1]}`;
      }

      overlay.innerHTML = `
        <div class="overlay-title">${title}</div>
        <div class="overlay-score">${scoreText}</div>
        <div class="overlay-reason">${reason}</div>
        ${lastSessionId ? `<div class="overlay-id">${lastSessionId}</div>` : ''}
      `;

      const btnRow = document.createElement('div');
      btnRow.className = 'btn-row';

      if (mode !== 'replay') {
        const retryBtn = document.createElement('button');
        retryBtn.className = 'action-btn primary';
        retryBtn.textContent = 'RETRY';
        retryBtn.onclick = () => {
          overlay.remove();
          currentRunner.restart();
        };
        btnRow.appendChild(retryBtn);
      }

      // Replay button — replay the session that just ended
      if (lastSession && mode !== 'replay') {
        const replayBtn = document.createElement('button');
        replayBtn.className = 'action-btn';
        replayBtn.textContent = 'REPLAY';
        replayBtn.onclick = () => {
          overlay.remove();
          stopGame();
          launchReplay(entry, lastSession);
        };
        btnRow.appendChild(replayBtn);
      }

      const menuBtn = document.createElement('button');
      menuBtn.className = 'action-btn';
      menuBtn.textContent = 'MENU';
      menuBtn.onclick = () => {
        overlay.remove();
        showMenu();
      };
      btnRow.appendChild(menuBtn);

      overlay.appendChild(btnRow);
      gameContainer.appendChild(overlay);
    }

    // -----------------------------------------------------------------------
    // SCREEN: Sessions List (Replays)
    // -----------------------------------------------------------------------
    async function showSessionsList() {
      document.body.className = 'in-menu';
      menuEl.style.display = 'flex';
      gameContainer.style.display = 'none';
      document.title = 'Replays \u2014 Game Lab';

      menuEl.innerHTML = '';

      const title = document.createElement('div');
      title.className = 'menu-title';
      title.style.fontSize = '22px';
      title.textContent = 'REPLAYS';
      menuEl.appendChild(title);

      const backLink = document.createElement('button');
      backLink.className = 'menu-link';
      backLink.textContent = '\u2190 Back to menu';
      backLink.style.marginBottom = '12px';
      backLink.onclick = showMenu;
      menuEl.appendChild(backLink);

      const loading = document.createElement('div');
      loading.className = 'pregame-desc';
      loading.textContent = 'Loading sessions...';
      menuEl.appendChild(loading);

      try {
        const resp = await fetch('/api/sessions?limit=50');
        const sessions = await resp.json();
        loading.remove();

        if (sessions.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'pregame-desc';
          empty.textContent = 'No sessions recorded yet. Play a game!';
          menuEl.appendChild(empty);
          return;
        }

        for (const s of sessions) {
          const item = document.createElement('div');
          item.className = 'session-item';

          const left = document.createElement('div');
          const gameEntry = GAMES.find(g => g.id === s.gameId);
          const gameName = gameEntry ? gameEntry.name : s.gameId;

          left.innerHTML = `
            <div class="session-game">${gameName}</div>
            <div class="session-time">${new Date(s.timestamp).toLocaleString()}</div>
            ${s.botPlay !== undefined ? '<div class="session-bot">BOT</div>' : ''}
          `;

          const right = document.createElement('div');
          right.style.textAlign = 'right';
          right.innerHTML = `
            <div class="session-score">${s.score?.primary ?? '—'}${s.score?.unit || ''}</div>
            <div class="session-time">${s.inputCount} inputs</div>
          `;

          item.appendChild(left);
          item.appendChild(right);

          item.onclick = async () => {
            const gameEntry = GAMES.find(g => g.id === s.gameId);
            if (!gameEntry) return;

            try {
              const resp = await fetch(`/api/session/${s.id}`);
              const session = await resp.json();
              launchReplay(gameEntry, session);
            } catch (e) {
              console.error('Failed to load session:', e);
            }
          };

          menuEl.appendChild(item);
        }
      } catch (e) {
        loading.textContent = 'Failed to load sessions.';
      }
    }

    // -----------------------------------------------------------------------
    // SCREEN: Settings
    // -----------------------------------------------------------------------
    function showSettings() {
      document.body.className = 'in-menu';
      menuEl.style.display = 'flex';
      gameContainer.style.display = 'none';
      document.title = 'Settings \u2014 Game Lab';

      menuEl.innerHTML = '';

      const title = document.createElement('div');
      title.className = 'menu-title';
      title.style.fontSize = '22px';
      title.textContent = 'SETTINGS';
      menuEl.appendChild(title);

      const backLink = document.createElement('button');
      backLink.className = 'menu-link';
      backLink.textContent = '\u2190 Back to menu';
      backLink.style.marginBottom = '16px';
      backLink.onclick = showMenu;
      menuEl.appendChild(backLink);

      // Volume
      const volRow = document.createElement('div');
      volRow.className = 'settings-row';
      const volLabel = document.createElement('span');
      volLabel.className = 'settings-label';
      volLabel.textContent = 'Volume';
      volRow.appendChild(volLabel);

      const volSlider = document.createElement('input');
      volSlider.type = 'range';
      volSlider.min = '0';
      volSlider.max = '100';
      volSlider.value = String(Math.round(masterVolume * 100));
      volSlider.style.width = '150px';
      volSlider.style.accentColor = '#4af';

      const volVal = document.createElement('span');
      volVal.className = 'slider-val';
      volVal.textContent = volSlider.value + '%';

      volSlider.oninput = () => {
        masterVolume = parseInt(volSlider.value) / 100;
        volVal.textContent = volSlider.value + '%';
        localStorage.setItem('gl_volume', String(masterVolume));
        if (audioEngine) audioEngine.setVolume(masterVolume);
      };

      volRow.appendChild(volSlider);
      volRow.appendChild(volVal);
      menuEl.appendChild(volRow);

      // Version info
      if (buildVersion) {
        const verRow = document.createElement('div');
        verRow.className = 'settings-row';
        verRow.style.marginTop = '24px';
        const verLabel = document.createElement('span');
        verLabel.className = 'settings-label';
        verLabel.textContent = 'Build';
        verRow.appendChild(verLabel);
        const verVal = document.createElement('span');
        verVal.className = 'slider-val';
        verVal.textContent = buildVersion;
        verRow.appendChild(verVal);
        menuEl.appendChild(verRow);
      }
    }

    // -----------------------------------------------------------------------
    // Utilities
    // -----------------------------------------------------------------------
    function stopGame() {
      if (currentRunner) { currentRunner.stop(); currentRunner = null; }
      if (currentInput) { currentInput.detach(); currentInput = null; }
      modeBadge.style.display = 'none';
      calibrateBtn.style.display = 'none';
      // Remove any pause overlay
      const po = gameContainer.querySelector('.pause-overlay');
      if (po) po.remove();
    }

    function resizeCanvas() {
      if (!canvas) return;
      const dpr = window.devicePixelRatio || 1;
      const w = window.innerWidth;
      const h = window.innerHeight;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
    }

    async function saveSession(session) {
      try {
        const resp = await fetch('/api/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(session),
        });
        const result = await resp.json();
        console.log('Session saved:', result.id);
        return result.id;
      } catch (e) {
        console.warn('Session save failed:', e.message);
        return null;
      }
    }

    // -----------------------------------------------------------------------
    // Events
    // -----------------------------------------------------------------------
    backBtn.onclick = () => {
      if (currentRunner) {
        if (currentRunner.mode !== 'replay') {
          const session = currentRunner.getSession();
          saveSession(session);
        }
      }
      showMenu();
    };

    calibrateBtn.onclick = () => {
      if (!currentRunner || !currentInput) return;
      // Pause the game
      currentRunner.stop();
      calibrateBtn.style.display = 'none';

      // Show pause overlay with instructions
      const overlay = document.createElement('div');
      overlay.className = 'pause-overlay';
      overlay.innerHTML = `
        <div class="overlay-title">PAUSED</div>
        <div class="pause-msg">Hold your phone in the position<br>you want to be level</div>
      `;
      const resumeBtn = document.createElement('button');
      resumeBtn.className = 'action-btn primary';
      resumeBtn.textContent = 'RESUME';
      resumeBtn.onclick = () => {
        currentInput.calibrateGyro();
        overlay.remove();
        calibrateBtn.style.display = 'block';
        currentRunner.start();
      };
      overlay.appendChild(resumeBtn);
      gameContainer.appendChild(overlay);
    };

    window.addEventListener('resize', () => {
      if (gameContainer.style.display !== 'none') resizeCanvas();
    });

    window.addEventListener('popstate', () => {
      const path = location.pathname.replace(/^\//, '');
      const game = GAMES.find(g => g.id === path);
      if (game) showPreGame(game);
      else showMenu();
    });

    // Unlock audio on first interaction
    document.addEventListener('touchstart', () => ensureAudio(), { once: true });
    document.addEventListener('click', () => ensureAudio(), { once: true });

    // -----------------------------------------------------------------------
    // Route: check URL path on load
    // -----------------------------------------------------------------------
    const path = location.pathname.replace(/^\//, '');
    const directGame = GAMES.find(g => g.id === path);
    if (directGame) {
      showPreGame(directGame);
    } else {
      showMenu();
    }
  </script>
</body>
</html>
